Generic single-database configuration.
# ğŸ“˜ **Alembic Migrations â€“ Project Documentation**

This directory contains the full Alembic migration environment for the **ArcoirisPOS backend**.
It manages schema creation, upgrades, and autogeneration across the following PostgreSQL schemas:

* **core**
* **acct**
* **pos**
* **inv**
* **public** (only contains `alembic_version`)

---

# ğŸ“ Directory Structure

```
backend/database/migrations/
â”‚
â”œâ”€â”€ env.py                  # Alembic migration environment
â”œâ”€â”€ script.py.mako          # Template for new revision files
â”œâ”€â”€ manual_sql/             # Hand-written SQL scripts (optional)
â””â”€â”€ versions/               # Auto-generated migration scripts
```

---

# âš™ï¸ Database Requirements

Your Postgres instance must have:

```sql
CREATE EXTENSION IF NOT EXISTS citext;
CREATE EXTENSION IF NOT EXISTS pgcrypto;
```

These are required for:

* Case-insensitive email fields (`CITEXT`)
* UUID generation via `gen_random_uuid()` (`pgcrypto`)

---

# ğŸ§  Migration Environment Behavior (env.py)

The env.py file is customized to support:

### âœ” Multiple schemas

Alembic reflects and compares across:

```
core, acct, pos, inv, public
```

### âœ” Custom object filter: ignore alembic_version

We exclude the version table from autogenerate:

```python
def include_object(object, name, type_, reflected, compare_to):
    if type_ == "table":
        obj_schema = getattr(object, "schema", None)
        if obj_schema == "public" and name == "alembic_version":
            return False
    if type_ == "index":
        return False
    if type_ == "unique_constraint" and reflected and not compare_to:
        return False
    return True
```

### âœ” Database URL via application settings

env.py loads the DB connection from:

```
from src.core.config import settings
settings.database_url
```

ensuring migrations always run against the correct environment.

---

# ğŸš€ Typical Developer Workflow

### **Create a new migration (autogenerate)**

```
alembic revision --autogenerate -m "short description"
```

### **Apply all migrations**

```
alembic upgrade head
```

### **Show current DB version**

```
alembic current
```

### **View migration history**

```
alembic history
```

### **Stamp the database (mark without running migrations)**

Useful for resetting Alembicâ€™s state when DB and code diverge:

```
alembic stamp head
```

---

# ğŸ§° Manual SQL

The `manual_sql/` directory contains optional hand-written SQL for:

* early schema prototypes
* advanced migration tasks
* troubleshooting

These scripts are **not** executed automatically.

---

# ğŸ§¼ Development Notes

* Maintain one clear upgrade path per table.
* Avoid editing old migrations; always create new ones.
* Keep SQLAlchemy models and migrations synchronized.
* If autogenerate detects a missing `alembic_version`, run a `stamp` command to realign the database.

---

# ğŸ“Œ Current Stable Baseline

As of this documentation update:

* Alembic is fully synchronized
* Migrations autogenerate cleanly
* Multi-schema reflection works correctly
* The env.py configuration is stable